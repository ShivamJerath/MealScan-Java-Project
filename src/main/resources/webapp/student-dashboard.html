<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MealScan - Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        .table {
            margin-bottom: 0;
        }
        .badge {
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        .btn-primary {
            background: #007bff;
            border: none;
        }
        .btn-success {
            background: #28a745;
            border: none;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .nav-tabs .nav-link {
            color: #667eea;
            border: none;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-upc-scan"></i> MealScan - Student Dashboard
            </span>
            <div class="d-flex align-items-center">
                <span class="text-white me-3">
                    <i class="bi bi-person-circle"></i> <span id="userName"></span>
                </span>
                <button class="btn btn-outline-light" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-value" id="messTotal">₹0.00</div>
                    <div class="text-muted">Total Mess Bill</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <div class="stat-value" id="canteenTotal">₹0.00</div>
                    <div class="text-muted">Total Canteen Bill</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> My Records</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-4" id="recordTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="mess-tab" data-bs-toggle="tab" 
                                data-bs-target="#mess" type="button" role="tab">
                            <i class="bi bi-egg-fried"></i> Mess Records
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="canteen-tab" data-bs-toggle="tab" 
                                data-bs-target="#canteen" type="button" role="tab">
                            <i class="bi bi-cup-hot"></i> Canteen Records
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="recordTabContent">
                    <div class="tab-pane fade show active" id="mess" role="tabpanel">
                        <div class="mb-3">
                            <button class="btn btn-success" onclick="showBillModal('MESS')">
                                <i class="bi bi-file-earmark-text"></i> Generate Monthly Bill
                            </button>
                        </div>
                        <div id="messRecords"></div>
                    </div>
                    <div class="tab-pane fade" id="canteen" role="tabpanel">
                        <div class="mb-3">
                            <button class="btn btn-success" onclick="showBillModal('CANTEEN')">
                                <i class="bi bi-file-earmark-text"></i> Generate Monthly Bill
                            </button>
                        </div>
                        <div id="canteenRecords"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bill Modal -->
    <div class="modal fade" id="billModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title">Monthly Bill</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Month</label>
                            <select class="form-select" id="billMonth"></select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Year</label>
                            <select class="form-select" id="billYear"></select>
                        </div>
                    </div>
                    <button class="btn btn-primary mb-3" onclick="generateBill()">
                        <i class="bi bi-calculator"></i> Generate Bill
                    </button>
                    <div id="billContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUser = null;
        let currentBillType = null;

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            populateDateSelectors();
        });

        function checkAuth() {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            if (currentUser.role !== 'STUDENT') {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('userName').textContent = currentUser.name;
            loadRecords();
        }

        async function loadRecords() {
            await loadRecordsByType('MESS');
            await loadRecordsByType('CANTEEN');
        }

        async function loadRecordsByType(type) {
            try {
                const response = await fetch(`/api/records?type=${type}`);
                const data = await response.json();
                
                if (data.success) {
                    displayRecords(data.records, type);
                    updateTotal(data.records, type);
                }
            } catch (error) {
                console.error('Error loading records:', error);
            }
        }

        function displayRecords(records, type) {
            const containerId = type === 'MESS' ? 'messRecords' : 'canteenRecords';
            const container = document.getElementById(containerId);
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <h5>No records found</h5>
                        <p class="text-muted">Your ${type.toLowerCase()} records will appear here</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Meal Type</th>
                                <th>Items</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            records.forEach(record => {
                html += `
                    <tr>
                        <td>${formatDate(record.recordDate)}</td>
                        <td><span class="badge bg-info">${record.mealType}</span></td>
                        <td>${record.items}</td>
                        <td class="fw-bold">₹${parseFloat(record.cost).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function updateTotal(records, type) {
            const total = records.reduce((sum, r) => sum + parseFloat(r.cost), 0);
            const elementId = type === 'MESS' ? 'messTotal' : 'canteenTotal';
            document.getElementById(elementId).textContent = `₹${total.toFixed(2)}`;
        }

        function showBillModal(type) {
            currentBillType = type;
            document.getElementById('billContent').innerHTML = '';
            new bootstrap.Modal(document.getElementById('billModal')).show();
        }

        async function generateBill() {
            const month = document.getElementById('billMonth').value;
            const year = document.getElementById('billYear').value;
            
            try {
                const response = await fetch(
                    `/api/bills?type=${currentBillType}&year=${year}&month=${month}`
                );
                const data = await response.json();
                
                if (data.success) {
                    displayBill(data);
                } else {
                    alert(data.error);
                }
            } catch (error) {
                alert('Error generating bill');
            }
        }

        function displayBill(data) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">${currentBillType} Bill - ${monthNames[data.month-1]} ${data.year}</h6>
                    </div>
                    <div class="card-body">
            `;
            
            if (data.records.length === 0) {
                html += '<p class="text-muted">No records for this period</p>';
            } else {
                html += `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead><tr><th>Date</th><th>Meal</th><th>Items</th><th>Cost</th></tr></thead>
                            <tbody>
                `;
                data.records.forEach(r => {
                    html += `
                        <tr>
                            <td>${formatDate(r.recordDate)}</td>
                            <td>${r.mealType}</td>
                            <td>${r.items}</td>
                            <td>₹${parseFloat(r.cost).toFixed(2)}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                html += `<hr><h5 class="text-end">Total: ₹${parseFloat(data.total).toFixed(2)}</h5>`;
            }
            
            html += '</div></div>';
            document.getElementById('billContent').innerHTML = html;
        }

        function populateDateSelectors() {
            const monthSelect = document.getElementById('billMonth');
            const yearSelect = document.getElementById('billYear');
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            
            months.forEach((month, idx) => {
                monthSelect.innerHTML += `<option value="${idx+1}">${month}</option>`;
            });
            
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 5; year--) {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            }
            
            monthSelect.value = new Date().getMonth() + 1;
            yearSelect.value = currentYear;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric' 
            });
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            } catch (error) {
                localStorage.removeItem('user');
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>